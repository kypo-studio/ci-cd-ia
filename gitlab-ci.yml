# .gitlab-ci.yml - Exercice 6: CI/CD avec Tests et Release

image: node:20-alpine

cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/

stages:
  - validate
  - test
  - build
  - release
  - deploy

# ========================================
# ANCHORS - Configurations rÃ©utilisables
# ========================================

.rules-no-tag-no-release: &rules-no-tag-no-release
  rules:
    - if: '$CI_COMMIT_TAG == null && $CI_COMMIT_MESSAGE !~ /^chore: release/'

.rules-main-only: &rules-main-only
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

.git-setup: &git-setup
  before_script:
    - apk add --no-cache git
    - git config user.email "${GITLAB_USER_EMAIL}"
    - git config user.name "${GITLAB_USER_NAME}"
    - git remote set-url origin "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git checkout "${CI_COMMIT_BRANCH}"
    - git pull origin "${CI_COMMIT_BRANCH}" --rebase

.node-setup: &node-setup
  before_script:
    - apk add --no-cache git
    - npm ci --cache .npm --prefer-offline

# ========================================
# STAGE: .pre - Installation des dÃ©pendances
# ========================================

install:
  stage: .pre
  <<: *node-setup
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
      - .npm/
    policy: pull-push

# ========================================
# STAGE: validate - Linting
# ========================================

lint:
  stage: validate
  needs: ['install']
  <<: *node-setup
  script:
    - npm run lint
  <<: *rules-no-tag-no-release
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
      - .npm/
    policy: pull

format-check:
  stage: validate
  needs: ['install']
  <<: *node-setup
  script:
    - npm run format:check
  <<: *rules-no-tag-no-release
  allow_failure: true
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
    policy: pull

# ========================================
# STAGE: test - Tests unitaires avec couverture
# ========================================

test:unit:
  stage: test
  needs: ['install', 'lint']
  <<: *node-setup
  script:
    - npm run test:unit
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: coverage/junit.xml
    paths:
      - coverage/
    expire_in: 30 days
  <<: *rules-no-tag-no-release
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
    policy: pull

# ========================================
# STAGE: build - Construction de l'image Docker
# ========================================

build:docker:
  stage: build
  image: docker:24-alpine
  services:
    - docker:24-dind
  needs: ['test:unit']
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      echo "ðŸ³ Building Docker image..."
      docker build \
        --build-arg NODE_ENV=production \
        --platform linux/amd64 \
        -t $IMAGE_TAG \
        -t $IMAGE_LATEST \
        .
    - |
      echo "ðŸ“¤ Pushing Docker images..."
      docker push $IMAGE_TAG
      docker push $IMAGE_LATEST
    - |
      echo "âœ… Images pushed:"
      echo "  - $IMAGE_TAG"
      echo "  - $IMAGE_LATEST"
  <<: *rules-no-tag-no-release

# ========================================
# STAGE: release - Versioning automatique
# ========================================

release:
  stage: release
  needs: ['build:docker']
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TAG == null && $CI_COMMIT_TITLE !~ /^chore: release/'
  before_script:
    - apk add --no-cache git
    - git config user.email "${GITLAB_USER_EMAIL}"
    - git config user.name "${GITLAB_USER_NAME}"
    # Utiliser GITLAB_TOKEN pour les releases
    - git remote set-url origin "https://gitlab-ci-token:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git checkout "${CI_COMMIT_BRANCH}"
    - git pull origin "${CI_COMMIT_BRANCH}" --rebase
    - npm ci --cache .npm --prefer-offline
  script:
    - |
      echo "ðŸ” Checking GITLAB_TOKEN..."
      if [ -z "$GITLAB_TOKEN" ]; then
        echo "âŒ ERROR: GITLAB_TOKEN is not set in CI/CD variables"
        echo "Please add it in: Settings > CI/CD > Variables"
        exit 1
      fi
    - |
      echo "ðŸ“¦ Running release-it..."
      export GITLAB_TOKEN="${GITLAB_TOKEN}"
      npx --yes release-it --ci --verbose
  artifacts:
    paths:
      - CHANGELOG.md
    expire_in: 1 year
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
      - .npm/
    policy: pull

# ========================================
# STAGE: deploy - DÃ©ploiement (placeholder)
# ========================================

deploy:staging:
  stage: deploy
  image: alpine:latest
  needs: ['release']
  <<: *rules-main-only
  when: manual
  environment:
    name: staging
    url: https://staging.example.com
  before_script:
    - apk add --no-cache curl
  script:
    - |
      echo "ðŸš€ Deploying to staging..."
      echo "Image: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
      echo "âš ï¸  Deploy script to be implemented"
    # Exemple de dÃ©ploiement (Ã  adapter selon votre infrastructure)
    # - kubectl set image deployment/app app=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    # - kubectl rollout status deployment/app

deploy:production:
  stage: deploy
  image: alpine:latest
  needs: ['deploy:staging']
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
  when: manual
  environment:
    name: production
    url: https://app.example.com
  before_script:
    - apk add --no-cache curl
  script:
    - |
      echo "ðŸš€ Deploying to production..."
      echo "Tag: $CI_COMMIT_TAG"
      echo "Image: $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG"
      echo "âš ï¸  Deploy script to be implemented"
