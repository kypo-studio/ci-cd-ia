# .gitlab-ci.yml

stages:
  - validate
  - test
  - build
  - release

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

# ================================================================
# STAGE 1: VALIDATION
# ================================================================

lint:
  stage: validate
  image: python:3.11-slim
  before_script:
    - pip install black flake8 bandit
  script:
    - echo "üîç Checking code format..."
    - black --check app/ tests/ || true
    - echo "üîç Linting with flake8..."
    - flake8 app/ tests/ --max-line-length=120
    - echo "üîí Security scan with bandit..."
    - bandit -r app/ -ll
    - echo "‚úÖ Validation passed"

secrets_scan:
  stage: validate
  image: zricethezav/gitleaks:latest
  script:
    - gitleaks detect --no-git --verbose --source .
    - echo "‚úÖ No secrets detected"

# ================================================================
# STAGE 2: TESTS
# ================================================================

unit_tests:
  stage: test
  image: python:3.11-slim
  before_script:
    - pip install -r requirements.txt pytest pytest-cov
  script:
    - pytest tests/unit/ -v --cov=app --cov-report=term
    - echo "‚úÖ Unit tests passed"
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

e2e_tests:
  stage: test
  image: python:3.11-slim
  before_script:
    - pip install -r requirements.txt pytest requests
  script:
    - echo "üöÄ Starting API server..."
    - python app.py &
    - sleep 5
    - echo "üß™ Running E2E tests..."
    - pytest tests/e2e/ -v
    - echo "‚úÖ E2E tests passed"
  variables:
    GEMINI_API_KEY: $GEMINI_API_KEY

# ================================================================
# STAGE 3: BUILD
# ================================================================

build_docker:
  stage: build
  image: docker:24-alpine
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üî® Building Docker image..."
    - docker build -t $IMAGE_NAME:$IMAGE_TAG -t $IMAGE_NAME:latest .
    - echo "üì§ Pushing to registry..."
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - docker push $IMAGE_NAME:latest
    - echo "‚úÖ Image pushed: $IMAGE_NAME:$IMAGE_TAG"
  only:
    - main
    - tags

# ================================================================
# STAGE 4: RELEASE
# ================================================================

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "üì¶ Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    description: |
      ## Release $CI_COMMIT_TAG
      
      ### Docker Image
      \`\`\`bash
      docker pull $IMAGE_NAME:$CI_COMMIT_TAG
      docker run -p 8080:8080 -e GEMINI_API_KEY=your_key $IMAGE_NAME:$CI_COMMIT_TAG
      \`\`\`
      
      ### Changes
      - Build: $CI_COMMIT_SHORT_SHA
      - Pipeline: $CI_PIPELINE_URL
    assets:
      links:
        - name: 'Docker Image'
          url: '$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG'
          link_type: 'image'
  only:
    - tags
